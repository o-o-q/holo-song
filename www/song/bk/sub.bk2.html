<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Document</title>
<style>
ul {
  list-style-type: none;
}
</style>
</head>
<body>
<input type='text' id="keyword" size="100" placeholder="空白区切りでand条件 カンマ区切りでor条件  例) フレア,わため,ねね cover,歌ってみた">
<ul id="list">
</ul>
<script>
const xhr = new XMLHttpRequest();
xhr.open("GET", 'https://ooq.jp/pri/holo/song/data/s.ltst.json');
xhr.send();

xhr.onreadystatechange = () =>{
  if (xhr.readyState == 4 && xhr.status == 200) {
    const jsonObj = JSON.parse(xhr.responseText);      
    for (let item of jsonObj) {        
      console.log("id: " + item.id + " title: " + item.title + " completed: " + item.completed);        
    }
  }
}

var data_jsn = {}

var video_id_srt = new Array()
for (let [video_id, tbl] of Object.entries(data_jsn)) {
  if(tbl.view_cnt){
    video_id_srt.push(video_id)
  }
}
video_id_srt.sort(function (video_id1, video_id2) {
  var ret = data_jsn[video_id2].view_cnt - data_jsn[video_id1].view_cnt;
  return ret
});

var data_jsn_srt = new Array()
video_id_srt.forEach(function (video_id) {
  data_jsn_srt.push(data_jsn[video_id])
});

var data = new Array()
for (let [video_id, tbl] of Object.entries(data_jsn_srt)) {
  data.push(tbl.view_cnt + " " + tbl.title)
}

var keyupStack = [];
var keyword = document.getElementById('keyword');
keyword.addEventListener('keyup', function () {
  keyupStack.push(1);

  setTimeout(function () {
    keyupStack.pop();

    // 最後にkeyupされてから一定時間次の入力がなかったら実行
    if (keyupStack.length === 0) {

      var words_and = this.value.split(/\s/g);
      words_and.forEach(function(w,idx,ws){
        if (w.indexOf(',') >= 0){
          ws[idx] = w.replace(new RegExp("^" + "," + "+|" + "," + "+$", "g"),'').split(',');
        }
      });
      var filteredLists = data.filter(function (d) {
        return words_and.every(function (w_and) {
          var ret
          if (typeof w_and == "string" ) {
            ret = d.toLowerCase().indexOf(w_and.toLowerCase()) >= 0;
          }else if(typeof w_and == "object"){
            ret = w_and.some(function(w_or){
              return d.toLowerCase().indexOf(w_or.toLowerCase()) >= 0;
            });
          }
          return ret;
        });
      });
      createRow(filteredLists);
    }
  }.bind(this), 300);
});

var createRow = function (lists) {
  var list = document.getElementById('list');
  list.textContent = null;
  lists.forEach(function (l) {
    var li = document.createElement('li');
    li.appendChild(document.createTextNode(l));
    list.appendChild(li);
  });
};

// 初期表示
createRow(data);
document.getElementById('keyword').focus();

</script>
</body>
</html>

